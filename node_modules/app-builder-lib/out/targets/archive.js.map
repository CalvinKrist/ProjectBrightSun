{"version":3,"sources":["../../src/targets/archive.ts"],"names":[],"mappings":"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","sourcesContent":["import { path7za } from \"7zip-bin\"\nimport { debug7z, debug7zArgs, exec } from \"builder-util\"\nimport { exists, unlinkIfExists } from \"builder-util/out/fs\"\nimport { move } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { TmpDir } from \"temp-file\"\nimport { CompressionLevel } from \"../core\"\nimport { getLinuxToolsPath } from \"./tools\"\n\n/** @internal */\nexport async function tar(compression: CompressionLevel | any | any, format: string, outFile: string, dirToArchive: string, isMacApp: boolean, tempDirManager: TmpDir): Promise<void> {\n  const tarFile = await tempDirManager.getTempFile({suffix: \".tar\"})\n  const tarArgs = debug7zArgs(\"a\")\n  tarArgs.push(tarFile)\n  tarArgs.push(path.basename(dirToArchive))\n\n  await Promise.all([\n    exec(path7za, tarArgs, {cwd: path.dirname(dirToArchive)}),\n    // remove file before - 7z doesn't overwrite file, but update\n    unlinkIfExists(outFile),\n  ])\n\n  if (!isMacApp) {\n    await exec(path7za, [\"rn\", tarFile, path.basename(dirToArchive), path.basename(outFile, `.${format}`)])\n  }\n\n  if (format === \"tar.lz\") {\n    // noinspection SpellCheckingInspection\n    let lzipPath = \"lzip\"\n    if (process.platform === \"darwin\") {\n      lzipPath = path.join(await getLinuxToolsPath(), \"bin\", lzipPath)\n    }\n    await exec(lzipPath, [compression === \"store\" ? \"-1\" : \"-9\", \"--keep\" /* keep (don't delete) input files */, tarFile])\n    // bloody lzip creates file in the same dir where input file with postfix `.lz`, option --output doesn't work\n    await move(`${tarFile}.lz`, outFile)\n    return\n  }\n\n  const args = compute7zCompressArgs(format === \"tar.xz\" ? \"xz\" : (format === \"tar.bz2\" ? \"bzip2\" : \"gzip\"), {\n    isRegularFile: true,\n    method: \"DEFAULT\",\n    compression,\n  })\n  args.push(outFile, tarFile)\n  await exec(path7za, args, {\n    cwd: path.dirname(dirToArchive),\n  }, debug7z.enabled)\n}\n\nexport interface ArchiveOptions {\n  compression?: CompressionLevel | null\n\n  /**\n   * @default false\n   */\n  withoutDir?: boolean\n\n  /**\n   * @default true\n   */\n  solid?: boolean\n\n  /**\n   * @default true\n   */\n  isArchiveHeaderCompressed?: boolean\n\n  listFile?: string\n\n  dictSize?: number\n  excluded?: Array<string> | null\n\n  // DEFAULT allows to disable custom logic and do not pass method switch at all\n  method?: \"Copy\" | \"LZMA\" | \"Deflate\" | \"DEFAULT\"\n\n  isRegularFile?: boolean\n}\n\nexport function compute7zCompressArgs(format: string, options: ArchiveOptions = {}) {\n  let storeOnly = options.compression === \"store\"\n  const args = debug7zArgs(\"a\")\n\n  let isLevelSet = false\n  if (process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL != null) {\n    storeOnly = false\n    args.push(`-mx=${process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL}`)\n    isLevelSet = true\n  }\n\n  const isZip = format === \"zip\"\n  if (!storeOnly) {\n    if (isZip && options.compression === \"maximum\") {\n      // http://superuser.com/a/742034\n      args.push(\"-mfb=258\", \"-mpass=15\")\n    }\n\n    if (!isLevelSet) {\n      // https://github.com/electron-userland/electron-builder/pull/3032\n      args.push(\"-mx=\" + ((!isZip || options.compression === \"maximum\") ? \"9\" : \"7\"))\n    }\n  }\n\n  if (options.dictSize != null) {\n    args.push(`-md=${options.dictSize}m`)\n  }\n\n  // https://sevenzip.osdn.jp/chm/cmdline/switches/method.htm#7Z\n  // https://stackoverflow.com/questions/27136783/7zip-produces-different-output-from-identical-input\n  // tc and ta are off by default, but to be sure, we explicitly set it to off\n  // disable \"Stores NTFS timestamps for files: Modification time, Creation time, Last access time.\" to produce the same archive for the same data\n  if (!options.isRegularFile) {\n    args.push(\"-mtc=off\")\n  }\n\n  if (format === \"7z\" || format.endsWith(\".7z\")) {\n    if (options.solid === false) {\n      args.push(\"-ms=off\")\n    }\n\n    if (options.isArchiveHeaderCompressed === false) {\n      args.push(\"-mhc=off\")\n    }\n\n    // args valid only for 7z\n    // -mtm=off disable \"Stores last Modified timestamps for files.\"\n    args.push(\"-mtm=off\", \"-mta=off\")\n  }\n\n  if (options.method != null) {\n    if (options.method !== \"DEFAULT\") {\n      args.push(`-mm=${options.method}`)\n    }\n  }\n  else if (isZip || storeOnly) {\n    args.push(`-mm=${storeOnly ? \"Copy\" : \"Deflate\"}`)\n  }\n\n  if (isZip) {\n    // -mcu switch:  7-Zip uses UTF-8, if there are non-ASCII symbols.\n    // because default mode: 7-Zip uses UTF-8, if the local code page doesn't contain required symbols.\n    // but archive should be the same regardless where produced\n    args.push(\"-mcu\")\n  }\n  return args\n}\n\n// 7z is very fast, so, use ultra compression\n/** @internal */\nexport async function archive(format: string, outFile: string, dirToArchive: string, options: ArchiveOptions = {}): Promise<string> {\n  const args = compute7zCompressArgs(format, options)\n  // remove file before - 7z doesn't overwrite file, but update\n  await unlinkIfExists(outFile)\n\n  args.push(outFile, options.listFile == null ? (options.withoutDir ? \".\" : path.basename(dirToArchive)) : `@${options.listFile}`)\n  if (options.excluded != null) {\n    for (const mask of options.excluded) {\n      args.push(`-xr!${mask}`)\n    }\n  }\n\n  try {\n    await exec(path7za, args, {\n      cwd: options.withoutDir ? dirToArchive : path.dirname(dirToArchive),\n    }, debug7z.enabled)\n  }\n  catch (e) {\n    if (e.code === \"ENOENT\" && !(await exists(dirToArchive))) {\n      throw new Error(`Cannot create archive: \"${dirToArchive}\" doesn't exist`)\n    }\n    else {\n      throw e\n    }\n  }\n\n  return outFile\n}"],"sourceRoot":""}
