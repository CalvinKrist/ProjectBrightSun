{"version":3,"sources":["../../src/targets/AppxTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { Arch, asArray, InvalidConfigurationError, log, deepAssign } from \"builder-util\"\nimport { copyOrLinkFile, walk } from \"builder-util/out/fs\"\nimport { emptyDir, readdir, readFile, writeFile } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { AppXOptions } from \"../\"\nimport { Target } from \"../core\"\nimport { getTemplatePath } from \"../util/pathManager\"\nimport { VmManager } from \"../vm/vm\"\nimport { getSignVendorPath, isOldWin6 } from \"../windowsCodeSign\"\nimport { WinPackager } from \"../winPackager\"\nimport { createStageDir } from \"./targetUtil\"\n\nconst APPX_ASSETS_DIR_NAME = \"appx\"\n\nconst vendorAssetsForDefaultAssets: { [key: string]: string; } = {\n  \"StoreLogo.png\": \"SampleAppx.50x50.png\",\n  \"Square150x150Logo.png\": \"SampleAppx.150x150.png\",\n  \"Square44x44Logo.png\": \"SampleAppx.44x44.png\",\n  \"Wide310x150Logo.png\": \"SampleAppx.310x150.png\",\n}\n\nconst DEFAULT_RESOURCE_LANG = \"en-US\"\n\nexport default class AppXTarget extends Target {\n  readonly options: AppXOptions = deepAssign({}, this.packager.platformSpecificBuildOptions, this.packager.config.appx)\n\n  constructor(private readonly packager: WinPackager, readonly outDir: string) {\n    super(\"appx\")\n\n    if (process.platform !== \"darwin\" && (process.platform !== \"win32\" || isOldWin6())) {\n      throw new Error(\"AppX is supported only on Windows 10 or Windows Server 2012 R2 (version number 6.3+)\")\n    }\n  }\n\n  // https://docs.microsoft.com/en-us/windows/uwp/packaging/create-app-package-with-makeappx-tool#mapping-files\n  async build(appOutDir: string, arch: Arch): Promise<any> {\n    const packager = this.packager\n    const artifactName = packager.expandArtifactNamePattern(this.options, \"appx\", arch)\n    const artifactPath = path.join(this.outDir, artifactName)\n    this.logBuilding(\"AppX\", artifactPath, arch)\n\n    const vendorPath = await getSignVendorPath()\n    const vm = await packager.vm.value\n\n    const stageDir = await createStageDir(this, packager, arch)\n\n    const mappingFile = stageDir.getTempFile(\"mapping.txt\")\n    const makeAppXArgs = [\"pack\", \"/o\" /* overwrite the output file if it exists */,\n      \"/f\", vm.toVmFile(mappingFile),\n      \"/p\", vm.toVmFile(artifactPath),\n    ]\n    if (packager.compression === \"store\") {\n      makeAppXArgs.push(\"/nc\")\n    }\n\n    const mappingList: Array<Array<string>> = []\n    mappingList.push(await BluebirdPromise.map(walk(appOutDir), file => {\n      let appxPath = file.substring(appOutDir.length + 1)\n      if (path.sep !== \"\\\\\") {\n        appxPath = appxPath.replace(/\\//g, \"\\\\\")\n      }\n      return `\"${vm.toVmFile(file)}\" \"app\\\\${appxPath}\"`\n    }))\n\n    const userAssetDir = await this.packager.getResource(undefined, APPX_ASSETS_DIR_NAME)\n    const assetInfo = await AppXTarget.computeUserAssets(vm, vendorPath, userAssetDir)\n    const userAssets = assetInfo.userAssets\n\n    const manifestFile = stageDir.getTempFile(\"AppxManifest.xml\")\n    await this.writeManifest(manifestFile, arch, await this.computePublisherName(), userAssets)\n    mappingList.push(assetInfo.mappings)\n    mappingList.push([`\"${vm.toVmFile(manifestFile)}\" \"AppxManifest.xml\"`])\n\n    if (isScaledAssetsProvided(userAssets)) {\n      const outFile = vm.toVmFile(stageDir.getTempFile(\"resources.pri\"))\n      const makePriPath = vm.toVmFile(path.join(vendorPath, \"windows-10\", Arch[arch], \"makepri.exe\"))\n\n      const assetRoot = stageDir.getTempFile(\"appx/assets\")\n      await emptyDir(assetRoot)\n      await BluebirdPromise.map(assetInfo.allAssets, it => copyOrLinkFile(it, path.join(assetRoot, path.basename(it))))\n\n      await vm.exec(makePriPath, [\"new\",\n        \"/Overwrite\",\n        \"/Manifest\", vm.toVmFile(manifestFile),\n        \"/ProjectRoot\", vm.toVmFile(path.dirname(assetRoot)),\n        \"/ConfigXml\", vm.toVmFile(path.join(getTemplatePath(\"appx\"), \"priconfig.xml\")),\n        \"/OutputFile\", outFile,\n      ])\n\n      // in addition to resources.pri, resources.scale-140.pri and other such files will be generated\n      for (const resourceFile of (await readdir(stageDir.dir)).filter(it => it.startsWith(\"resources.\")).sort()) {\n        mappingList.push([`\"${vm.toVmFile(stageDir.getTempFile(resourceFile))}\" \"${resourceFile}\"`])\n      }\n      makeAppXArgs.push(\"/l\")\n    }\n\n    let mapping = \"[Files]\"\n    for (const list of mappingList) {\n      mapping += \"\\r\\n\" + list.join(\"\\r\\n\")\n    }\n    await writeFile(mappingFile, mapping)\n    packager.debugLogger.add(\"appx.mapping\", mapping)\n\n    if (this.options.makeappxArgs != null) {\n      makeAppXArgs.push(...this.options.makeappxArgs)\n    }\n    await vm.exec(vm.toVmFile(path.join(vendorPath, \"windows-10\", Arch[arch], \"makeappx.exe\")), makeAppXArgs)\n    await packager.sign(artifactPath)\n\n    await stageDir.cleanup()\n\n    packager.info.dispatchArtifactCreated({\n      file: artifactPath,\n      packager,\n      arch,\n      safeArtifactName: packager.computeSafeArtifactName(artifactName, \"appx\"),\n      target: this,\n      isWriteUpdateInfo: this.options.electronUpdaterAware,\n    })\n  }\n\n  private static async computeUserAssets(vm: VmManager, vendorPath: string, userAssetDir: string | null) {\n    const mappings: Array<string> = []\n    let userAssets: Array<string>\n    const allAssets: Array<string> = []\n    if (userAssetDir == null) {\n      userAssets = []\n    }\n    else {\n      userAssets = (await readdir(userAssetDir)).filter(it => !it.startsWith(\".\") && !it.endsWith(\".db\") && it.includes(\".\"))\n      for (const name of userAssets) {\n        mappings.push(`\"${vm.toVmFile(userAssetDir)}${vm.pathSep}${name}\" \"assets\\\\${name}\"`)\n        allAssets.push(path.join(userAssetDir, name))\n      }\n    }\n\n    for (const defaultAsset of Object.keys(vendorAssetsForDefaultAssets)) {\n      if (userAssets.length === 0 || !isDefaultAssetIncluded(userAssets, defaultAsset)) {\n        const file = path.join(vendorPath, \"appxAssets\", vendorAssetsForDefaultAssets[defaultAsset])\n        mappings.push(`\"${vm.toVmFile(file)}\" \"assets\\\\${defaultAsset}\"`)\n        allAssets.push(file)\n      }\n    }\n\n    // we do not use process.arch to build path to tools, because even if you are on x64, ia32 appx tool must be used if you build appx for ia32\n    return {userAssets, mappings, allAssets}\n  }\n\n  // https://github.com/electron-userland/electron-builder/issues/2108#issuecomment-333200711\n  private async computePublisherName() {\n    if (await this.packager.cscInfo.value == null) {\n      log.info({reason: \"Windows Store only build\"}, \"AppX is not signed\")\n      return this.options.publisher || \"CN=ms\"\n    }\n\n    const publisher = await this.packager.computedPublisherSubjectOnWindowsOnly.value\n    if (!publisher) {\n      throw new Error(\"Internal error: cannot compute subject using certificate info\")\n    }\n    return publisher\n  }\n\n  private async writeManifest(outFile: string, arch: Arch, publisher: string, userAssets: Array<string>) {\n    const appInfo = this.packager.appInfo\n    const options = this.options\n    const executable = `app\\\\${appInfo.productFilename}.exe`\n    const displayName = options.displayName || appInfo.productName\n    const manifest = (await readFile(path.join(getTemplatePath(\"appx\"), \"appxmanifest.xml\"), \"utf8\"))\n      .replace(/\\${([a-zA-Z0-9]+)}/g, (match, p1): string => {\n        switch (p1) {\n          case \"publisher\":\n            return publisher\n\n          case \"publisherDisplayName\":\n            const name = options.publisherDisplayName || appInfo.companyName\n            if (name == null) {\n              throw new InvalidConfigurationError(`Please specify \"author\" in the application package.json — it is required because \"appx.publisherDisplayName\" is not set.`)\n            }\n            return name\n\n          case \"version\":\n            return appInfo.versionInWeirdWindowsForm\n\n          case \"applicationId\":\n            const result = options.applicationId || options.identityName || appInfo.name\n            if (!isNaN(parseInt(result[0], 10))) {\n              let message = `AppX Application.Id can’t start with numbers: \"${result}\"`\n              if (options.applicationId == null) {\n                message += `\\nPlease set appx.applicationId (or correct appx.identityName or name)`\n              }\n              throw new InvalidConfigurationError(message)\n            }\n            return result\n\n          case \"identityName\":\n            return options.identityName  || appInfo.name\n\n          case \"executable\":\n            return executable\n\n          case \"displayName\":\n            return displayName\n\n          case \"description\":\n            return appInfo.description || appInfo.productName\n\n          case \"backgroundColor\":\n            return options.backgroundColor || \"#464646\"\n\n          case \"logo\":\n            return \"assets\\\\StoreLogo.png\"\n\n          case \"square150x150Logo\":\n            return \"assets\\\\Square150x150Logo.png\"\n\n          case \"square44x44Logo\":\n            return \"assets\\\\Square44x44Logo.png\"\n\n          case \"lockScreen\":\n            return lockScreenTag(userAssets)\n\n          case \"defaultTile\":\n            return defaultTileTag(userAssets)\n\n          case \"splashScreen\":\n            return splashScreenTag(userAssets)\n\n          case \"arch\":\n            return arch === Arch.ia32 ? \"x86\" : \"x64\"\n\n          case \"resourceLanguages\":\n            return resourceLanguageTag(asArray(options.languages))\n\n          case \"extensions\":\n            return this.getExtensions(executable, displayName)\n\n          default:\n            throw new Error(`Macro ${p1} is not defined`)\n        }\n      })\n    await writeFile(outFile, manifest)\n  }\n\n  private getExtensions(executable: string, displayName: string): string {\n    let isAddAutoLaunchExtension = this.options.addAutoLaunchExtension\n    if (isAddAutoLaunchExtension === undefined) {\n      const deps = this.packager.info.metadata.dependencies\n      isAddAutoLaunchExtension = deps != null && deps[\"electron-winstore-auto-launch\"] != null\n    }\n\n    if (!isAddAutoLaunchExtension) {\n      return \"\"\n    }\n\n    return `<Extensions>\n    <desktop:Extension Category=\"windows.startupTask\" Executable=\"${executable}\" EntryPoint=\"Windows.FullTrustApplication\">\n      <desktop:StartupTask TaskId=\"SlackStartup\" Enabled=\"true\" DisplayName=\"${displayName}\" />\n    </desktop:Extension>\n  </Extensions>`\n  }\n}\n\n// get the resource - language tag, see https://docs.microsoft.com/en-us/windows/uwp/globalizing/manage-language-and-region#specify-the-supported-languages-in-the-apps-manifest\nfunction resourceLanguageTag(userLanguages: Array<string> | null | undefined): string {\n  if (userLanguages == null || userLanguages.length === 0) {\n    userLanguages = [DEFAULT_RESOURCE_LANG]\n  }\n  return userLanguages.map(it => `<Resource Language=\"${it.replace(/_/g, \"-\")}\" />`).join(\"\\n\")\n}\n\nfunction lockScreenTag(userAssets: Array<string>): string {\n  if (isDefaultAssetIncluded(userAssets, \"BadgeLogo.png\")) {\n    return '<uap:LockScreen Notification=\"badgeAndTileText\" BadgeLogo=\"assets\\\\BadgeLogo.png\" />'\n  }\n  else {\n    return \"\"\n  }\n}\n\nfunction defaultTileTag(userAssets: Array<string>): string {\n  const defaultTiles: Array<string> = [\"<uap:DefaultTile\", 'Wide310x150Logo=\"assets\\\\Wide310x150Logo.png\"']\n\n  if (isDefaultAssetIncluded(userAssets, \"LargeTile.png\")) {\n    defaultTiles.push('Square310x310Logo=\"assets\\\\LargeTile.png\"')\n  }\n  if (isDefaultAssetIncluded(userAssets, \"SmallTile.png\")) {\n    defaultTiles.push('Square71x71Logo=\"assets\\\\SmallTile.png\"')\n  }\n\n  defaultTiles.push(\"/>\")\n  return defaultTiles.join(\" \")\n}\n\nfunction splashScreenTag(userAssets: Array<string>): string {\n  if (isDefaultAssetIncluded(userAssets, \"SplashScreen.png\")) {\n    return '<uap:SplashScreen Image=\"assets\\\\SplashScreen.png\" />'\n  }\n  else {\n    return \"\"\n  }\n}\n\nfunction isDefaultAssetIncluded(userAssets: Array<string>, defaultAsset: string) {\n  const defaultAssetName = defaultAsset.substring(0, defaultAsset.indexOf(\".\"))\n  return userAssets.some(it => it.includes(defaultAssetName))\n}\n\nfunction isScaledAssetsProvided(userAssets: Array<string>) {\n  return userAssets.some(it => it.includes(\".scale-\") || it.includes(\".targetsize-\"))\n}"],"sourceRoot":""}
