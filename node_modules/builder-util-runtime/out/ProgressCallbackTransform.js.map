{"version":3,"sources":["../src/ProgressCallbackTransform.ts"],"names":[],"mappings":";;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAWM,MAAA,yBAAA,SAAyC,mBAAzC,CAAkD;AAOtD,cAA6B,KAA7B,EAA6D,iBAA7D,EAAoH,UAApH,EAA2J;AACzJ;AAD2B,SAAA,KAAA,GAAA,KAAA;AAAgC,SAAA,iBAAA,GAAA,iBAAA;AAAuD,SAAA,UAAA,GAAA,UAAA;AAN5G,SAAA,KAAA,GAAQ,KAAK,GAAL,EAAR;AACA,SAAA,WAAA,GAAc,CAAd;AACA,SAAA,KAAA,GAAQ,CAAR;AAEA,SAAA,UAAA,GAAa,KAAK,KAAL,GAAa,IAA1B;AAIP;;AAED,aAAW,KAAX,EAAuB,QAAvB,EAAyC,QAAzC,EAAsD;AACpD,QAAI,KAAK,iBAAL,CAAuB,SAA3B,EAAsC;AACpC,eAAS,IAAI,KAAJ,CAAU,WAAV,CAAT,EAAiC,IAAjC;AACA;AACD;;AAED,SAAK,WAAL,IAAoB,MAAM,MAA1B;AACA,SAAK,KAAL,IAAc,MAAM,MAApB;AAEA,UAAM,MAAM,KAAK,GAAL,EAAZ;;AACA,QAAI,OAAO,KAAK,UAAZ,IAA0B,KAAK,WAAL,KAAqB,KAAK;AAAM;AAA9D,MAA+F;AAC7F,aAAK,UAAL,GAAkB,MAAM,IAAxB;AAEA,aAAK,UAAL,CAAgB;AACd,iBAAO,KAAK,KADE;AAEd,iBAAO,KAAK,KAFE;AAGd,uBAAa,KAAK,WAHJ;AAId,mBAAU,KAAK,WAAL,GAAmB,KAAK,KAAzB,GAAkC,GAJ7B;AAKd,0BAAgB,KAAK,KAAL,CAAW,KAAK,WAAL,IAAoB,CAAC,MAAM,KAAK,KAAZ,IAAqB,IAAzC,CAAX;AALF,SAAhB;AAOA,aAAK,KAAL,GAAa,CAAb;AACD;;AAED,aAAS,IAAT,EAAe,KAAf;AACD;;AAED,SAAO,QAAP,EAAoB;AAClB,QAAI,KAAK,iBAAL,CAAuB,SAA3B,EAAsC;AACpC,eAAS,IAAI,KAAJ,CAAU,WAAV,CAAT;AACA;AACD;;AAED,SAAK,UAAL,CAAgB;AACd,aAAO,KAAK,KADE;AAEd,aAAO,KAAK,KAFE;AAGd,mBAAa,KAAK,KAHJ;AAId,eAAS,GAJK;AAKd,sBAAgB,KAAK,KAAL,CAAW,KAAK,WAAL,IAAoB,CAAC,KAAK,GAAL,KAAa,KAAK,KAAnB,IAA4B,IAAhD,CAAX;AALF,KAAhB;AAOA,SAAK,KAAL,GAAa,CAAb;AAEA,aAAS,IAAT;AACD;;AArDqD,C","sourcesContent":["import { Transform } from \"stream\"\nimport { CancellationToken } from \"./CancellationToken\"\n\nexport interface ProgressInfo {\n  total: number\n  delta: number\n  transferred: number\n  percent: number\n  bytesPerSecond: number\n}\n\nexport class ProgressCallbackTransform extends Transform {\n  private start = Date.now()\n  private transferred = 0\n  private delta = 0\n\n  private nextUpdate = this.start + 1000\n\n  constructor(private readonly total: number, private readonly cancellationToken: CancellationToken, private readonly onProgress: (info: ProgressInfo) => any) {\n    super()\n  }\n\n  _transform(chunk: any, encoding: string, callback: any) {\n    if (this.cancellationToken.cancelled) {\n      callback(new Error(\"Cancelled\"), null)\n      return\n    }\n\n    this.transferred += chunk.length\n    this.delta += chunk.length\n\n    const now = Date.now()\n    if (now >= this.nextUpdate && this.transferred !== this.total /* will be emitted on _flush */) {\n      this.nextUpdate = now + 1000\n\n      this.onProgress({\n        total: this.total,\n        delta: this.delta,\n        transferred: this.transferred,\n        percent: (this.transferred / this.total) * 100,\n        bytesPerSecond: Math.round(this.transferred / ((now - this.start) / 1000))\n      })\n      this.delta = 0\n    }\n\n    callback(null, chunk)\n  }\n\n  _flush(callback: any): void {\n    if (this.cancellationToken.cancelled) {\n      callback(new Error(\"Cancelled\"))\n      return\n    }\n\n    this.onProgress({\n      total: this.total,\n      delta: this.delta,\n      transferred: this.total,\n      percent: 100,\n      bytesPerSecond: Math.round(this.transferred / ((Date.now() - this.start) / 1000))\n    })\n    this.delta = 0\n\n    callback(null)\n  }\n}\n"],"sourceRoot":""}
