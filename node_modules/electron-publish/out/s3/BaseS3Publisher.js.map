{"version":3,"sources":["../../src/s3/BaseS3Publisher.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;;;;AAEM,MAAgB,eAAhB,SAAwC,sBAAxC,CAAiD;AACrD,cAAsB,OAAtB,EAAuD,OAAvD,EAA6E;AAC3E,UAAM,OAAN;AADqD,SAAA,OAAA,GAAA,OAAA;AAEtD;;AAIS,qBAAmB,IAAnB,EAAsC;AAC9C;AACA,QAAI,KAAK,OAAL,CAAa,GAAb,KAAqB,IAAzB,EAA+B;AAC7B,WAAK,IAAL,CAAU,OAAV,EAAmB,KAAK,OAAL,CAAa,GAAb,IAAoB,aAAvC;AACD;AACF,GAZoD,CAcrD;;;AACM,QAAN,CAAa,IAAb,EAA6B;AAAA;;AAAA;AAC3B,YAAM,WAAW,KAAK,QAAL,CAAc,KAAK,IAAnB,CAAjB;AACA,YAAM,oBAAoB,MAAK,OAAL,CAAa,iBAAvC;AAEA,YAAM,SAAS,CAAC,MAAK,OAAL,CAAa,IAAb,IAAqB,IAArB,GAA4B,EAA5B,GAAiC,GAAG,MAAK,OAAL,CAAa,IAAI,GAAtD,IAA6D,QAA5E;AAEA,YAAM,OAAO,CAAC,YAAD,EAAe,UAAf,EAA2B,MAAK,aAAL,EAA3B,EAAiD,OAAjD,EAA0D,MAA1D,EAAkE,QAAlE,EAA4E,KAAK,IAAjF,CAAb;;AACA,YAAK,kBAAL,CAAwB,IAAxB;;AAEA,UAAI,QAAQ,GAAR,CAAY,qBAAZ,IAAqC,IAAzC,EAA+C;AAC7C,cAAM,WAAW,KAAK,IAAL,CAAU,QAAQ,GAAR,CAAY,qBAAtB,EAA8C,MAA9C,CAAjB;AACA,cAAM,2BAAU,KAAK,OAAL,CAAa,QAAb,CAAV,CAAN;AACA,cAAM,yBAAQ,KAAK,IAAb,EAAmB,QAAnB,CAAN;AACA;AACD,OAd0B,CAgB3B;;;AACA,YAAK,iBAAL,CAAuB,QAAvB,EAAiC,CAAC,CAAlC,EAjB2B,CAkB3B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAEA,aAAO,MAAM,kBAAkB,aAAlB,CAAgC,CAAC,OAAD,EAAU,MAAV,EAAkB,QAAlB,KAA8B;AACzE,8CAAkB,IAAlB,EAAwB,WAAU;AAChC,mBAAS,MAAK;AACZ,oBAAQ,IAAR,CAAa,QAAb;AACD,WAFD;AAGD,SAJD,EAKG,IALH,CAKQ,MAAK;AACT,cAAI;AACF,+BAAI,KAAJ,CAAU;AAAC,wBAAU,MAAK,YAAhB;AAA8B,oBAAM,QAApC;AAA8C,sBAAQ,MAAK,aAAL;AAAtD,aAAV,EAAuF,UAAvF;AACD,WAFD,SAGQ;AACN;AACD;AACF,SAZH,EAaG,KAbH,CAaS,MAbT;AAcD,OAfY,CAAb;AA3B2B;AA2C5B;;AAED,aAAQ;AACN,WAAO,GAAG,KAAK,YAAY,aAAa,KAAK,aAAL,EAAoB,GAA5D;AACD;;AA9DoD,C","sourcesContent":["import { log, executeAppBuilder } from \"builder-util\"\nimport { BaseS3Options } from \"builder-util-runtime\"\nimport { PublishContext, Publisher, UploadTask } from \"../publisher\"\nimport { ensureDir, symlink } from \"fs-extra-p\"\nimport * as path from \"path\"\n\nexport abstract class BaseS3Publisher extends Publisher {\n  protected constructor(context: PublishContext, private options: BaseS3Options) {\n    super(context)\n  }\n\n  protected abstract getBucketName(): string\n\n  protected configureS3Options(args: Array<string>) {\n    // if explicitly set to null, do not add\n    if (this.options.acl !== null) {\n      args.push(\"--acl\", this.options.acl || \"public-read\")\n    }\n  }\n\n  // http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/s3-example-creating-buckets.html\n  async upload(task: UploadTask): Promise<any> {\n    const fileName = path.basename(task.file)\n    const cancellationToken = this.context.cancellationToken\n\n    const target = (this.options.path == null ? \"\" : `${this.options.path}/`) + fileName\n\n    const args = [\"publish-s3\", \"--bucket\", this.getBucketName(), \"--key\", target, \"--file\", task.file]\n    this.configureS3Options(args)\n\n    if (process.env.__TEST_S3_PUBLISHER__ != null) {\n      const testFile = path.join(process.env.__TEST_S3_PUBLISHER__!, target)\n      await ensureDir(path.dirname(testFile))\n      await symlink(task.file, testFile)\n      return\n    }\n\n    // https://github.com/aws/aws-sdk-go/issues/279\n    this.createProgressBar(fileName, -1)\n    // if (progressBar != null) {\n    //   const callback = new ProgressCallback(progressBar)\n    //   uploader.on(\"progress\", () => {\n    //     if (!cancellationToken.cancelled) {\n    //       callback.update(uploader.loaded, uploader.contentLength)\n    //     }\n    //   })\n    // }\n\n    return await cancellationToken.createPromise((resolve, reject, onCancel) => {\n      executeAppBuilder(args, process => {\n        onCancel(() => {\n          process.kill(\"SIGINT\")\n        })\n      })\n        .then(() => {\n          try {\n            log.debug({provider: this.providerName, file: fileName, bucket: this.getBucketName()}, \"uploaded\")\n          }\n          finally {\n            resolve()\n          }\n        })\n        .catch(reject)\n    })\n  }\n\n  toString() {\n    return `${this.providerName} (bucket: ${this.getBucketName()})`\n  }\n}\n"],"sourceRoot":""}
